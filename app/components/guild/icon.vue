<template>
	<div :class="['overflow-hidden rounded-full', size ? `w-${size} h-${size}` : '']">
		<picture v-if="guild?.icon && !isDefault">
			<source
				v-if="isAnimated"
				media="(prefers-reduced-motion: no-preference), (prefers-reduced-data: no-preference)"
				type="image/gif"
				:srcset="makeSrcset('gif')"
			/>
			<source type="image/webp" :srcset="makeSrcset('webp')" />
			<source type="image/png" :srcset="makeSrcset('png')" />
			<img :src="makeSrcset('png')" :alt="guild.name" class="h-full w-full object-cover" decoding="async" crossorigin="anonymous" />
		</picture>
		<div v-else class="flex h-full w-full items-center justify-center bg-gray-800 text-white">
			<span class="text-lg font-bold">{{ acronym }}</span>
		</div>
	</div>
</template>

<script setup lang="ts">
import type { ValuesType } from 'utility-types';
import type { TransformedLoginData } from '~~/shared/types';

interface GuildIconProps {
	guild?: ValuesType<NonNullable<TransformedLoginData['transformedGuilds']>>;
	size?: string;
}

const props = defineProps<GuildIconProps>();

const isDefault = ref(true);
const isAnimated = ref(false);

watch(
	() => props.guild,
	(guild) => {
		if (guild?.icon) {
			isDefault.value = false;
			isAnimated.value = guild.icon.startsWith('a_');
		} else {
			isDefault.value = true;
			isAnimated.value = false;
		}
	},
	{ immediate: true }
);

const acronym = computed(() => {
	return props.guild ? props.guild.acronym : '';
});

function createUrl(format: 'webp' | 'png' | 'gif', size: number) {
	return `https://cdn.discordapp.com/icons/${props.guild!.id}/${props.guild!.icon}.${format}?size=${size}`;
}

function makeSrcset(format: 'webp' | 'png' | 'gif') {
	return `${createUrl(format, 64)} 1x, ${createUrl(format, 128)} 2x, ${createUrl(format, 256)} 3x, ${createUrl(format, 512)} 4x`;
}
</script>
